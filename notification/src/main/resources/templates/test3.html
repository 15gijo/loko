<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>SSE μ•λ¦Ό ν…μ¤νΈ</title>
</head>
<body>
<h1>SSE μ•λ¦Ό μμ‹  ν…μ¤νΈ</h1>
<ul id="log"></ul>

<script>

  const userId = prompt("π” μ μ € IDλ¥Ό μ…λ ¥ν•μ„Έμ”", "1");
  const token = prompt("π”‘ JWT ν† ν°μ„ μ…λ ¥ν•μ„Έμ”");

  const baseUrl = "http://localhost:19091";
  const logContainer = document.getElementById("log");

  // β… μ•λ¦Ό λ©λ΅ λ λ”λ§ ν•¨μ
  function renderNotification(notification, isNew = false) {
    const li = document.createElement("li");
    li.textContent = `${isNew ? '[NEW] ' : '[UNREAD] '}${notification.notificationContent}`;
    li.dataset.id = notification.notificationId;
    li.style.cursor = "pointer";

    li.addEventListener("click", () => {
      const id = li.dataset.id;
      fetch(`${baseUrl}/api/v1/notifications/${id}/read`, {
        method: "PATCH",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      })
      .then(response => {
        if (response.ok) {
          li.style.textDecoration = "line-through";
          li.textContent += " (μ½μ)";
        } else {
          throw new Error(`μƒνƒ μ½”λ“: ${response.status}`);
        }
      })
      .catch(err => {
        console.error("β μ½μ μ²λ¦¬ μ‹¤ν¨", err);
        alert("μ•λ¦Ό μ½μ μ²λ¦¬μ— μ‹¤ν¨ν–μµλ‹λ‹¤.");
      });
    });

    logContainer.appendChild(li);
  }

  // β… SSE μ—°κ²° (Authorization ν—¤λ”λ” fetchλ΅ μ—°κ²° λ¶κ°€ β†’ fallback)
  const eventSource = new EventSource(`http://localhost:19098/api/v1/sse/subscribe?userId=${userId}`);

  eventSource.onopen = () => {
    console.log("β… SSE μ—°κ²° μ„±κ³µ");

    // λ―Έν™•μΈ μ•λ¦Ό λ©λ΅ μ΅°ν
    fetch(`${baseUrl}/api/v1/notifications`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) {
        throw new Error(`μ”μ²­ μ‹¤ν¨: ${res.status}`);
      }
      return res.json();
    })
    .then(response => {
      const notifications = response.data;
      if (!Array.isArray(notifications)) {
        throw new Error("μ‘λ‹µ λ°μ΄ν„°κ°€ λ°°μ—΄μ΄ μ•„λ‹™λ‹λ‹¤");
      }
      notifications.forEach(notification => renderNotification(notification));
    })
    .catch(err => {
      console.error("β λ―Έν™•μΈ μ•λ¦Ό λ¶λ¬μ¤κΈ° μ‹¤ν¨", err);
    });
  };

  eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    renderNotification(data, true);
  };

  eventSource.addEventListener("CONNECT", (event) => {
    const li = document.createElement("li");
    li.textContent = "[CONNECT] SSE μ—°κ²°λ¨";
    logContainer.appendChild(li);
  });

  eventSource.addEventListener("NEW", (event) => {
    const data = JSON.parse(event.data);
    renderNotification(data, true);
  });

  eventSource.onerror = (event) => {
    console.error("β SSE μ—°κ²° μ¤λ¥", event);
  };
</script>
</body>
</html>